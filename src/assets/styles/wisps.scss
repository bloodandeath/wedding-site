/* Sparkly Particle Wisps (Vue-rendered) */
.wisps {
    position: absolute;
    inset: 0;
    width: 100%;

    /* IMPORTANT: make the field as tall as the document */
    height: var(--pageH, 100vh);

    pointer-events: none;
    overflow: hidden;
    z-index: 0;
}

/* Helper: compile-time random number in a range (unitless) */
@function rr($min, $max) {
    @return $min + random($max - $min);
}

/* Helper: compile-time random px */
@function rpx($min, $max) {
    @return (rr($min, $max) * 1px);
}

/* Base wisp visual: POINT + BLOOM (not a “ball”) */
.wisp {
    position: absolute;
    left: var(--x);
    top: calc(var(--y) + (var(--scrollY, 0px) * var(--par, 0.12)));

    width: var(--s);
    height: var(--s);
    border-radius: 999px;

    background: transparent;

    /* crisp core + soft bloom */
    box-shadow:
            0 0 0 0.6px rgba(255, 255, 255, 0.85),
            0 0 10px rgba(255, 255, 255, 0.35),
            0 0 18px rgba(120, 255, 200, 0.22),
            0 0 28px rgba(32, 99, 63, 0.18);

    opacity: 0.55;
    mix-blend-mode: screen;

    transform: translate3d(0, 0, 0);
    will-change: transform, opacity, filter, top;
}

/* Soft star glint (rounded, not a hard right angle) */
.wisp::before {
    content: "";
    position: absolute;
    left: 50%;
    top: 50%;

    width: calc(var(--s) * 12);
    height: calc(var(--s) * 12);
    transform: translate(-50%, -50%) rotate(var(--rot, 0deg)) scale(0.85);

    pointer-events: none;
    opacity: 0;

    /* 4-point star + soft core */
    background:
            radial-gradient(circle, rgba(255,255,255,0.70), rgba(255,255,255,0) 38%),
            radial-gradient(circle, rgba(255,255,255,0.30), rgba(255,255,255,0) 62%),
            conic-gradient(
                            rgba(255,255,255,0) 0deg,
                            rgba(255,255,255,0.95) 7deg,
                            rgba(255,255,255,0) 14deg,
                            rgba(255,255,255,0) 90deg,
                            rgba(255,255,255,0.95) 97deg,
                            rgba(255,255,255,0) 104deg,
                            rgba(255,255,255,0) 180deg,
                            rgba(255,255,255,0.95) 187deg,
                            rgba(255,255,255,0) 194deg,
                            rgba(255,255,255,0) 270deg,
                            rgba(255,255,255,0.95) 277deg,
                            rgba(255,255,255,0) 284deg,
                            rgba(255,255,255,0) 360deg
            );

    /* KEY: taper outward so the spikes don't look wide at the edge */
    -webkit-mask-image: radial-gradient(
                    circle,
                    #000 0%,
                    #000 22%,
                    rgba(0,0,0,0.85) 34%,
                    rgba(0,0,0,0.35) 50%,
                    rgba(0,0,0,0.00) 66%
    );
    mask-image: radial-gradient(
                    circle,
                    #000 0%,
                    #000 22%,
                    rgba(0,0,0,0.85) 34%,
                    rgba(0,0,0,0.35) 50%,
                    rgba(0,0,0,0.00) 66%
    );

    filter: blur(0.55px);
}

/* --- SASS-generated uniqueness per particle --- */
$MAX_PARTICLES: 180;

/* Each particle gets:
   - pseudo-random multi-point drift path (non-predictable)
   - soft twinkle curve (no flicker)
   - occasional smooth glint
*/
@for $i from 1 through $MAX_PARTICLES {
    // drift offsets (px)
    $x0: rpx(-14, 14);
    $y0: rpx(-12, 12);

    $x1: rpx(-28, 28);
    $y1: rpx(-22, 22);

    $x2: rpx(-34, 34);
    $y2: rpx(-26, 26);

    $x3: rpx(-26, 26);
    $y3: rpx(-22, 22);

    $x4: rpx(-18, 18);
    $y4: rpx(-16, 16);

    $driftDur: rr(18, 44) * 1s;
    $twDur: rr(4, 10) * 1s;
    $glintDur: rr(7, 16) * 1s;

    // negative delays de-sync everything
    $driftDelay: -(rr(0, 40) * 1s);
    $twDelay: -(rr(0, 12) * 1s);
    $glintDelay: -(rr(0, 16) * 1s);

    // some particles glint more rarely
    $glintChance: rr(1, 20); // 1..4

    .wisp:nth-child(#{$i}) {
        animation:
                wisp-drift-#{$i} $driftDur ease-in-out infinite,
                wisp-twinkle-#{$i} $twDur ease-in-out infinite;

        animation-delay: $driftDelay, $twDelay;

        // give each wisp a different sparkle angle
        --rot: #{rr(0, 360)}deg;
    }

    // only ~25% glint to avoid “too much happening”
    @if $glintChance <= 4 {
        .wisp:nth-child(#{$i})::before {
            animation: wisp-glint-#{$i} $glintDur ease-in-out infinite;
            animation-delay: $glintDelay;
        }
    }

    @keyframes wisp-drift-#{$i} {
        0%   { transform: translate3d($x0, $y0, 0); }
        22%  { transform: translate3d($x1, $y1, 0); }
        48%  { transform: translate3d($x2, $y2, 0); }
        72%  { transform: translate3d($x3, $y3, 0); }
        100% { transform: translate3d($x4, $y4, 0); }
    }

    /* Soft twinkle: gentle, noticeable, not flickery */
    @keyframes wisp-twinkle-#{$i} {
        0%, 100% {
            opacity: 0.38;
            filter: blur(0.10px);
        }
        35% {
            opacity: 0.62;
            filter: blur(0.22px);
        }
        55% {
            opacity: 0.92;
            filter: blur(0.34px);
        }
        70% {
            opacity: 0.52;
            filter: blur(0.16px);
        }
    }

    @keyframes wisp-glint-#{$i} {
        0%, 80%, 100% {
            opacity: 0;
            transform: translate(-50%, -50%) rotate(var(--rot)) scale(0.82);
            filter: blur(0.60px);
        }
        86% {
            opacity: 0.22;
            transform: translate(-50%, -50%) rotate(var(--rot)) scale(0.94);
            filter: blur(0.56px);
        }
        90% {
            opacity: 0.70;
            transform: translate(-50%, -50%) rotate(var(--rot)) scale(1.08);
            filter: blur(0.48px);
        }
        94% {
            opacity: 0.14;
            transform: translate(-50%, -50%) rotate(var(--rot)) scale(0.92);
            filter: blur(0.58px);
        }
    }
}
